import{g as e,r as o,a as n,s as t,n as a,c as s,w as i,i as c,o as r,b as d,d as l,e as p,f as g}from"./index-XRL4FCaQ.js";import{_ as f}from"./_plugin-vue_export-helper.BCo6x5W8.js";const h=f({data:()=>({jssdkConfig:{nonceStr:"",timestamp:""}}),onLoad(){this.checkLogin(),this.jssdkConfig.timestamp=Math.floor(Date.now()/1e3).toString(),this.jssdkConfig.nonceStr=this.generateNonceStr(),this.loadJssdk()},methods:{loadJssdk(){const e=document.createElement("script");e.type="text/javascript",e.src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js",e.onload=()=>{this.initJssdk()},document.head.appendChild(e)},generateNonceStr(e=16){const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let n="";for(let t=0;t<e;t++)n+=o.charAt(Math.floor(Math.random()*o.length));return n},checkLogin(){e("token")||o({url:"/pages/login/login"})},async initJssdk(){try{const e=await n({url:"http://ebbhospital.binglang6.com/api/jssdkConfig",method:"GET",data:this.jssdkConfig});if(console.log("Config response:",e.data),e.data){const o=e.data;"undefined"!=typeof wx&&wx.config?(console.log("Configuring JSSDK with:",o),wx.config({debug:!0,appId:o.appId,timestamp:o.timestamp,nonceStr:o.nonceStr,signature:o.signature,jsApiList:["scanQRCode"]}),wx.ready((()=>{console.log("JSSDK ready")})),wx.error((e=>{console.error("JSSDK error:",e),t({title:"初始化失败",icon:"none"})}))):(console.error("wx.config not found, wx:",wx),t({title:"微信环境未就绪",icon:"none"}))}}catch(e){console.error("init jssdk error:",e),t({title:"初始化失败",icon:"none"})}},openScan(){"undefined"!=typeof wx&&wx.scanQRCode?wx.scanQRCode({needResult:1,scanType:["qrCode"],success:e=>{const o=e.resultStr.match(/appoint:(\d+)/);o&&o[1]?this.verifyQrCode(o[1]):t({title:"无效的二维码",icon:"none"})},fail:e=>{console.error("Scan failed:",e),t({title:"扫码失败",icon:"none"})}}):(console.error("wx.scanQRCode not found"),t({title:"微信环境未就绪",icon:"none"}))},async verifyQrCode(s){try{const i=e("token"),c=await n({url:"http://ebbhospital.binglang6.com/api/appoint-view",method:"GET",data:{id:s},header:{Authorization:"bearer "+i}});200===c.data.code?a({url:`/pages/detail/detail?id=${s}`}):401===c.data.code?o({url:"/pages/login/login"}):t({title:c.data.msg||"二维码验证失败",icon:"none"})}catch(i){console.error("Verify QR code error:",i),t({title:"验证失败",icon:"none"})}}}},[["render",function(e,o,n,t,a,f){const h=p,u=g,m=c;return r(),s(m,{class:"container"},{default:i((()=>[d(m,{class:"scan-area"},{default:i((()=>[d(m,{class:"scan-btn",onClick:f.openScan},{default:i((()=>[d(m,{class:"scan-content"},{default:i((()=>[d(h,{class:"scan-icon",src:e.scanIcon,mode:"aspectFit"},null,8,["src"]),d(u,{class:"scan-text"},{default:i((()=>[l("点击扫码")])),_:1})])),_:1})])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-23da5a54"]]);export{h as default};
