<?php

namespace common\models;

use Yii;

/**
 * This is the model class for table "hospital_appoint".
 *
 * @property int $id
 * @property int $doctorid
 * @property int $cycle
 * @property int $delay
 * @property int type
 * @property int weeks
 * @property int updateInterval
 * @property int interval
 */
class HospitalAppoint extends \yii\db\ActiveRecord
{
    public $week;
    public static $cycleText=[1=>'1周',2=>'2周',3=>'1个月'];
    public static $cycleNum=[1=>7,2=>14,3=>30];
    public static $typeText=[1=>'体检预约',2=>'疫苗预约',3=>'微量元素',4=>'成人疫苗'];
    public static $intervalText=[1=>'一小时',2=>'半小时'];

    /**
     * {@inheritdoc}
     */
    public static function tableName()
    {
        return 'hospital_appoint';
    }

    /**
     * {@inheritdoc}
     */
    public function rules()
    {
        return [
            [['cycle','delay','week'], 'required'],
            [['doctorid', 'cycle', 'delay','weeks','interval','updateInterval'], 'integer'],
        ];
    }

    /**
     * {@inheritdoc}
     */
    public function attributeLabels()
    {
        return [
            'id' => 'ID',
            'doctorid' => 'Doctorid',
            'cycle' => 'Cycle',
            'delay' => 'Delay',
            'type' => 'Type',
            'weeks' => 'weeks',
            'interval'=>'预约时间段',
            'updateInterval'=>'间隔时间段上线时间'

        ];
    }
    public function beforeSave($insert)
    {
        if($this->week){
            $this->weeks=implode('',$this->week);
        }
        if(!$insert){
            $attributes=$this->getOldAttributes();
            if($attributes['interval']!=$this->interval){
                if($this->updateInterval && $this->updateInterval>time()){
                    //如果生效日期已存在并且 大于当前日期 则代表用户需要修改为原来状态  清空生效日期
                    $this->updateInterval=0;
                }else {
                    $day = self::$cycleNum[$this->cycle] + 1;
                    $updateInterval = strtotime('+ ' . $day . ' day', strtotime(date("Y-m-d"), time()));
                    $appoint = Appoint::find()->where(['doctorid' => $this->doctorid])->orderBy('appoint_date desc')->one();
                    if ($appoint && $appoint->appoint_date >= $updateInterval) {
                        $updateInterval = strtotime('+1 day', $appoint->appoint_date);
                    }
                    $this->updateInterval = $updateInterval;
                }
            }
        }
        return parent::beforeSave($insert); // TODO: Change the autogenerated stub
    }
}
